<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="Term.css.template" rel="stylesheet" type="text/css" id="ss" />
        <title>Aptana Web Terminal</title>
		<script src="webterm_compressed.js"></script>
        <script>
            var terminal;
			var terminalElementID = "terminal";
			var characterWidth = null, characterHeight = null;
			var RESIZE_INTERVAL = 250;
			var resizeID = null;
            
			/**
			 * init
			 */
            function init()
            {
				var query = getQuery();
				
				var config = {
					id: (query !== null && query.hasOwnProperty("id")) ? query.id : null,
					autoStart: false,
					showTitle: false
				};
				
				// create terminal
                terminal = new Term(terminalElementID, 80,20, config);
				
				// resize to fit
				resizeHelper();
				
				// start processing
				terminal.toggleRunState();
            }
			
			/**
			 * getQuery
			 */
			function getQuery()
			{
				var query = window.location.search.substring(1);
				var keypairs = query.split("&");
				var result = {};
				
				for (var i = 0; i < keypairs.length; i++)
				{
					var parts = keypairs[i].split("=");
					var key = parts[0];
					var value = parts[1];
					
					result[key] = value;
				}
				
				return result;
			}
            
			/**
			 * autoSize
			 */
			function autoSize()
			{
				if (resizeID !== null)
				{
					window.clearTimeout(resizeID);
				}
				
				resizeID = window.setTimeout(resizeHelper, RESIZE_INTERVAL);
			}
			
			/**
			 * resizeHelper
			 */
			function resizeHelper()
			{
				// clear timeout id
				resizeID = null;
				
				if (characterWidth === null || characterHeight === null)
				{
					var div = document.getElementById(terminalElementID);
					
					// save current font-weight and then set to bold
					var oldWeight = div.style.fontWeight;
					div.style.fontWeight = "bold";
					
					// get div's width and height
					var divWidth = div.offsetWidth;
					var divHeight = div.offsetHeight;
					
					// restore original font-weight
					div.style.fontWeight = oldWeight;
					
					// calculate average width/height of a character
					characterWidth = divWidth / terminal.getWidth();
					characterHeight = divHeight / terminal.getHeight();
				}
				
				var width = Math.floor(getWindowWidth() / characterWidth);
				var height = Math.floor(getWindowHeight() / characterHeight);
				
				terminal.setSize(width,height);
			}
			
			/**
			 * getWindowWidth
			 */
			function getWindowWidth()
			{
				var result = 0;
				
				if (window.innerWidth)
				{
					result = window.innerWidth;
				}
				else if (document.documentElement && document.documentElement.clientWidth)
				{
					result = document.documentElement.clientWidth;
				}
				else if (document.body && document.body.clientWidth)
				{
					result = document.body.clientWidth;
				}
				
				return result;
			}
			
			/**
			 * getWindowHeight
			 */
			function getWindowHeight()
			{
				var result = 0;
				
				if (window.innerHeight)
				{
					result = window.innerHeight;
				}
				else if (document.documentElement && document.documentElement.clientHeight)
				{
					result = document.documentElement.clientHeight;
				}
				else if (document.body && document.body.clientHeight)
				{
					result = document.body.clientHeight;
				}
				
				return result;
			}
			
			/**
			 * onThemeChange
			 */
			function onThemeChange()
			{
				// reload CSS
				var s = document.getElementById('ss');
				var h = s.href.replace(/(&|\\?)forceReload=d /,'');
				
				s.href = h + (h.indexOf('?') >= 0 ? '&' : '?') + 'forceReload=' + (new Date().valueOf());
				
				window.setTimeout(
					function()
					{
						// clear character size cache and force resize
						characterWidth = null;
						characterHeight = null;
						resizeHelper();
					},
					1000
				);
			}
        </script>
    </head>
    <body onload="init();" onresize="autoSize();">
		<div id="terminal"></div>
    </body>
</html>
